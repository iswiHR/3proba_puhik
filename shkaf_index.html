  <!-- Three.js и GLTFLoader -->
  <script src="https://unpkg.com/three@0.128.0/build/three.min.js"></script>
  <script src="https://unpkg.com/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>

  <script>
    // -----------------------------
    // 3D СЦЕНА
    // -----------------------------

    let scene, camera, renderer;
    let monster = null;
    let fallbackMonster = null;
    let monsterContainer = null;

    function createFallbackMonster() {
      // если уже есть — не создаём второй
      if (fallbackMonster) return;

      const geometry = new THREE.SphereGeometry(0.7, 32, 32);
      const material = new THREE.MeshStandardMaterial({ color: 0xff3030 });
      fallbackMonster = new THREE.Mesh(geometry, material);
      fallbackMonster.position.set(0, -0.2, 0);
      scene.add(fallbackMonster);
      console.warn("Используем запасного красного монстра вместо GLB");
    }

    function initThree() {
      monsterContainer = document.getElementById("monster-canvas");
      if (!monsterContainer) {
        console.error("Не найден контейнер для монстрика");
        return;
      }

      scene = new THREE.Scene();

      const width = monsterContainer.clientWidth;
      const height = monsterContainer.clientHeight || width;

      camera = new THREE.PerspectiveCamera(35, width / height, 0.1, 100);
      camera.position.set(0, 0.8, 3);

      renderer = new THREE.WebGLRenderer({
        antialias: true,
        alpha: true
      });

      renderer.setPixelRatio(window.devicePixelRatio);
      renderer.setSize(width, height);
      renderer.setClearColor(0x000000, 0); // прозрачный фон
      monsterContainer.appendChild(renderer.domElement);

      // Свет
      const hemiLight = new THREE.HemisphereLight(0xffffff, 0x444444, 1);
      hemiLight.position.set(0, 1, 0);
      scene.add(hemiLight);

      const dirLight = new THREE.DirectionalLight(0xffffff, 0.8);
      dirLight.position.set(2, 2, 2);
      scene.add(dirLight);

      // -----------------------------
      // ЗАГРУЗКА GLB С ОТЛАДКОЙ
      // -----------------------------
      const loader = new THREE.GLTFLoader();

      fetch("monster.glb")
        .then((response) => {
          console.log(
            "monster.glb статус:",
            response.status,
            response.statusText
          );
          console.log("monster.glb content-type:", response.headers.get("content-type"));
          return response.arrayBuffer();
        })
        .then((buffer) => {
          console.log("monster.glb размер (байт):", buffer.byteLength);

          // если вдруг прилетело что-то подозрительно маленькое — сразу fallback
          if (buffer.byteLength < 1000) {
            console.error("monster.glb слишком маленький, похоже, битый файл");
            createFallbackMonster();
            animate();
            return;
          }

          loader.parse(
            buffer,
            "",
            function (gltf) {
              console.log("GLB успешно распарсен");
              monster = gltf.scene;
              monster.position.set(0, -0.6, 0);
              monster.scale.set(1.4, 1.4, 1.4);

              // если был шарик-запаска — убираем его
              if (fallbackMonster) {
                scene.remove(fallbackMonster);
                fallbackMonster = null;
              }

              scene.add(monster);
              animate();
            },
            function (error) {
              console.error("GLTFLoader.parse выдал ошибку:", error);
              createFallbackMonster();
              animate();
            }
          );
        })
        .catch((error) => {
          console.error("fetch monster.glb упал с ошибкой:", error);
          createFallbackMonster();
          animate();
        });

      window.addEventListener("resize", onWindowResize);
    }

    function onWindowResize() {
      if (!monsterContainer || !renderer || !camera) return;

      const width = monsterContainer.clientWidth;
      const height = monsterContainer.clientHeight || width;

      renderer.setSize(width, height);
      camera.aspect = width / height;
      camera.updateProjectionMatrix();
    }

    function animate() {
      requestAnimationFrame(animate);

      if (monster) {
        monster.rotation.y += 0.01;
      }
      if (fallbackMonster) {
        fallbackMonster.rotation.y += 0.01;
      }

      renderer.render(scene, camera);
    }

    // -----------------------------
    // UI: модалка и кнопки (оставил как было)
    // -----------------------------

    document.addEventListener("DOMContentLoaded", function () {
      const hangerBtn = document.getElementById("hanger-btn");
      const sideBtn1 = document.getElementById("side-btn-1");
      const sideBtn2 = document.getElementById("side-btn-2");
      const coinBtn = document.getElementById("coin-btn");
      const plusBtn = document.getElementById("plus-btn");

      const modalBackdrop = document.getElementById("locked-modal");
      const modalCloseBtn = document.getElementById("modal-close-btn");

      function openLockedModal() {
        modalBackdrop.classList.add("visible");
      }

      function closeLockedModal() {
        modalBackdrop.classList.remove("visible");
      }

      hangerBtn.addEventListener("click", openLockedModal);
      sideBtn1.addEventListener("click", openLockedModal);

      sideBtn2.addEventListener("click", function () {
        console.log("Вторая боковая кнопка нажата");
      });

      modalCloseBtn.addEventListener("click", closeLockedModal);

      modalBackdrop.addEventListener("click", function (event) {
        if (event.target === modalBackdrop) {
          closeLockedModal();
        }
      });

      coinBtn.addEventListener("click", function () {
        console.log("Кнопка монет нажата");
      });

      plusBtn.addEventListener("click", function () {
        console.log("Кнопка '+' нажата");
      });
    });

    window.addEventListener("load", initThree);
  </script>
